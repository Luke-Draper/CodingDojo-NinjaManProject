<html>
	<head>
		<title>Ninja-Man</title>
		<style type="text/css">
			* {
				margin: 0;
				padding: 0;
				line-height: 0;
			}
			.tile {
				height: 40px;
				width: 40px;
				display: inline-block;
			}
			.init {
				background-color: purple;
			}
			.wall {
				background-color: darkslategray;
			}
			.onigiri {
				background-color: white;
				background-image: url("img/onigiri.png");
				background-size: contain;
			}
			.sushi {
				background-color: white;
				background-image: url("img/sushi.png");
				background-size: contain;
			}
			.blank {
				background-color: white;
			}
			#ninja-man {
				background-image: url("img/ninja.gif");
				background-size: contain;
				position: absolute;
				top: 40px;
				left: 40px;
			}
			#red {
				background-color: white;
				background-image: url("img/red.gif");
				background-size: contain;
				position: absolute;
				top: 40px;
				left: 40px;
			}
			#pumpky {
				background-color: white;
				background-image: url("img/pumpky.gif");
				background-size: contain;
				position: absolute;
				top: 40px;
				left: 40px;
			}
			#pinky {
				background-color: white;
				background-image: url("img/pinky.gif");
				background-size: contain;
				position: absolute;
				top: 40px;
				left: 40px;
			}
			#bluey {
				background-color: white;
				background-image: url("img/bluey.gif");
				background-size: contain;
				position: absolute;
				top: 40px;
				left: 40px;
			}
		</style>
	</head>
	<body>
		<div id="game">
			<div id="grid"></div>
			<div id="ninja-man" class="tile"></div>
		</div>
		<script type="text/javascript">
			
			const TILE_SIZE = 40;
			const GRID_WIDTH = 12, GRID_HEIGHT = 12; // These values do not include the exterior walls of the grid
			const GAME_TICK_TIME = 25;
			const NINJAMAN_MOVEMENT_SPEED = 6, PUMPKIN_MOVEMENT_SPEED = 7; // Ticks per move
			const STARTING_LIVES = 3;
			const SUSHI_POWER_TIME = 40;
			const SUSHI_SCORE = 20, ONIGIRI_SCORE = 5;

			var gridArray = [];
			var gridEnum = { // More expressive code when declaring types
				init: 1,
				blank: 2,
				wall: 3,
				onigiri: 4,
				sushi: 5
			}
			var gridDict = {
				1: 'init',
				2: 'blank',
				3: 'wall',
				4: 'onigiri',
				5: 'sushi'
			}
			var ninjaMan = {
				currentTick: 1,
				x: 0,
				y: 0,
				score: 0,
				invulnerable: false, //TODO
				flashCount: 0, //whether he is visible after being hit during invulnerability
				livesRemaining: STARTING_LIVES,
				sushiPower: false, //TODO
				sushiPowerTimeRemaining: 0
			}
			var keyEnum = {
				none: 0,
				up: 1,
				down: 2,
				left: 3,
				right: 4
			}
			var currentKey = keyEnum.none;
			var timer = null;

			
			function initializeGame() {
				resetNinjaMan();
				initializeGrid();
				randomizeGrid();
				drawWorld();
				//placeNinjaMan(); //TODO
				updateNinjaMan();
				//placeGhosts(); //TODO
				//updateGhosts(); //TODO
				timer = window.setInterval(gameTick, GAME_TICK_TIME);
			}

			function endGame() {
				console.log("Your score is : " + ninjaMan.score);
				if (timer != null) {
					window.clearInterval(timer);
					timer = null;
				}
			}

			function resetNinjaMan() {
				ninjaMan.currentTick = 1;
				ninjaMan.x = 0;
				ninjaMan.y = 0;
				ninjaMan.score = 0;
				ninjaMan.invulnerable = false;
				ninjaMan.flashCount = 0;
				ninjaMan.livesRemaining = STARTING_LIVES;
				ninjaMan.sushiPower = false;
				ninjaMan.sushiPowerTimeRemaining = 0;
			}

			function initializeGrid() {
				for (var y=0; y<GRID_HEIGHT; y++) {
					var rowArray = [];
					for (var x=0; x<GRID_WIDTH; x++) {
						rowArray.push(gridEnum.blank);
					}
					gridArray.push(rowArray);
				}
			}
			
			function randomizeGrid() {
				//TODO
			}

			function drawWorld() {
				var gridContent = "";
				//Add Top Wall
				gridContent += "<div class='row'>";
				for (var temp=0; temp<GRID_WIDTH+2; temp++) {
					gridContent += "<div class='tile wall'></div>";
				}
				//Add Array Content
				gridContent += "</div>";
				for (var row=0; row<GRID_HEIGHT; row++) {
					gridContent += "<div class='row'><div class='tile wall'></div>";
					for (var col=0; col<GRID_WIDTH; col++) {
						gridContent += ("<div class='tile " + gridDict[gridArray[row][col]] + "'></div>");
					}
					gridContent += "<div class='tile wall'></div></div>";
				}
				//Add Bottom Wall
				gridContent += "<div class='row'>";
				for (var temp=0; temp<GRID_WIDTH+2; temp++) {
					gridContent += "<div class='tile wall'></div>";
				}
				gridContent += "</div>";
				document.getElementById('grid').innerHTML = gridContent;
			}

			function ninjaManGameTick() {
				if (ninjaMan.currentTick >= NINJAMAN_MOVEMENT_SPEED) {
					currentKeyNinjaManCheck();
					ninjaMan.currentTick = 1;
				} else {
					ninjaMan.currentTick++;
				}
			}

			function currentKeyNinjaManCheck() {
				if(currentKey == keyEnum.left) { // LEFT
					moveNinjaMan(-1,0);
					document.getElementById("ninja-man").style.transform = "scaleX(-1)";
				}
				else if (currentKey == keyEnum.right) { // RIGHT
					moveNinjaMan(1,0);
					document.getElementById("ninja-man").style.transform = "";
				}
				else if (currentKey == keyEnum.up) { // UP
					moveNinjaMan(0,-1);
					document.getElementById("ninja-man").style.transform = "rotate(-90deg)";
				}
				else if (currentKey == keyEnum.down) { // DOWN
					moveNinjaMan(0,1);
					document.getElementById("ninja-man").style.transform = "rotate(90deg)";
				}
			}

			function moveNinjaMan(xMove,yMove) {
				if (ninjaMan.y + yMove < 0 || ninjaMan.y + yMove >= GRID_HEIGHT || ninjaMan.x + xMove < 0 || ninjaMan.x + xMove >= GRID_WIDTH) {
					return; //Prevent moving off the board
				}
				if (gridArray[ninjaMan.y + yMove][ninjaMan.x + xMove] == gridEnum.blank || gridArray[ninjaMan.y + yMove][ninjaMan.x + xMove] == gridEnum.onigiri || gridArray[ninjaMan.y + yMove][ninjaMan.x + xMove] == gridEnum.sushi) {
					ninjaMan.x += xMove;
					ninjaMan.y += yMove;
					updateNinjaMan();
					updateScore();
				}
			}

			function updateNinjaMan() {
				document.getElementById("ninja-man").style.left = (ninjaMan.x + 1) * TILE_SIZE + "px";
				document.getElementById("ninja-man").style.top = (ninjaMan.y + 1) * TILE_SIZE + "px";
			}

			function updateScore() {
				if (gridArray[ninjaMan.y][ninjaMan.x] == gridEnum.onigiri) {
					gridArray[ninjaMan.y][ninjaMan.x] = gridEnum.blank;
					drawWorld();
					ninjaMan.score += ONIGIRI_SCORE;
				} else if (gridArray[ninjaMan.y][ninjaMan.x] == gridEnum.sushi) {
					gridArray[ninjaMan.y][ninjaMan.x] = gridEnum.blank;
					drawWorld();
					ninjaMan.score += SUSHI_SCORE;
				}
			}

			document.onkeydown = function(e) {
				if(e.keyCode == 37) { // LEFT
					currentKey = keyEnum.left;
				}
				else if (e.keyCode == 39) { // RIGHT
					currentKey = keyEnum.right;
				}
				else if (e.keyCode == 38) { // UP
					currentKey = keyEnum.up;
				}
				else if (e.keyCode == 40) { // DOWN
					currentKey = keyEnum.down;
				}
			}
			document.onkeyup = function(e) {
				if(e.keyCode == 37 && currentKey == keyEnum.left) { // LEFT
					currentKey = keyEnum.none;
				}
				else if (e.keyCode == 39 && currentKey == keyEnum.right) { // RIGHT
					currentKey = keyEnum.none;
				}
				else if (e.keyCode == 38 && currentKey == keyEnum.up) { // UP
					currentKey = keyEnum.none;
				}
				else if (e.keyCode == 40 && currentKey == keyEnum.down) { // DOWN
					currentKey = keyEnum.none;
				}
			}

			function gameTick() {
				ninjaManGameTick();
			}

			initializeGame();
		</script>
	</body>
</html>